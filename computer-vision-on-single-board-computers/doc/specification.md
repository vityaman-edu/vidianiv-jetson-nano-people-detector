# Техническое задание по проекту "Создание системы видеонаблюдения на базе одноплатных компьютеров"

# Общие сведения

## Цель проекта

Изучить одноплатные компьютеры и способы взаимодействия с ними и
реализовать пакет программного обеспечения для распознавания людей
на видео для микрокомпьютера (в частности для подсчета людей в помещении).

## Команда исполнителей

- Беляков Дмитрий
- Кривошеев Андрей
- Смирнов Виктор
- Тюрин Иван

# Технические требования

## Требования к функциональным характеристикам

### Общие требования

0. Система должна работать с одной камерой.

1. Система должна осуществлять трансляцию видеоряда с камер на
   клиентские приложения.

2. Система должна хранить записи о количестве людей от каждой камеры
   в конкретный момент времени.

3. Система должна предоставлять доступ к хранимой информации через
   сетевой API.

### Требования к пользовательскому интерфейсу

1. Пользовательский интерфейс реализован в виде программного приложения
   для персональных компьютеров.

2. В приложении можно посмотреть трансляцию видео с конкретной камеры.

3. В приложении можно получить список всех записей с количеством людей
   в помещении за заданный промежуток времени.

## Описание работы системы

Система состоит из следующих частей:

- Видеокамера
- Плата Jetson Nano
  - Модуль приема видео
  - Модуль предобработки кадров
  - Модуль обработки кадров
  - Модуль постобработки кадров
  - Модуль API
- Бэкэнд
  - Сервис сбора и обработки данных
    - Модуль приема видео и откликов
    - Модуль бизнес-логики
    - Модуль хранения данных
    - Модуль API
  - Хранилище данных
    - PostgreSQL
- Клиент
  - Веб-сайт или десктопное приложение
    - Модуль взаимодействия с API Бэкенда
    - Модуль представления данных

## Этапы работы

| Этап   | **1. Прием видео с камеры**                                            |
| ------ | ---------------------------------------------------------------------- |
| Акторы | Камера, Jetson Nano: Модуль приема видео                               |
| Вход   | Массив изображений - видео, а также время записи                       |
| Выход  | Преобразованные в программные сущности полученные данных: время, видео |

> Данные в бинарном формате по проводу поступают в Jetson Nano, и попадают в
> Модуль приема видео, в котором поток байтов преобразуется в программные сущности,
> а также обрабатываются ошибки ввода-вывода. На данном этапе мы можем потерять
> некоторую служебную информацию с камеры, может быть какие-то особенности формата.

| Этап   | **2. Предобработка кадров**                                    |
| ------ | -------------------------------------------------------------- |
| Акторы | Jetson Nano: Модуль предобработки видео                        |
| Вход   | Близкие кадры из видео                                         |
| Выход  | Близкие кадры из видео, пригодные для подачи на вход нейросети |

> На данном этапе мы выбираем некоторые кадры из видео.
> если одна плата будет обслуживать несколько камер, то будем
> выстраивать кадры в очередь.
> Для начала будем брать каждый кадр после того, как обработали предыдущий,
> и применяем к ним различные фильтры: повышаем контрастность, убираем цвета,
> подавляем шум, чтобы нейросеть смогла принять его на вход.

| Этап   | **3. Обработка кадров**              |
| ------ | ------------------------------------ |
| Акторы | Jetson Nano: Модуль обработки кадров |
| Вход   | Предобработанные кадры из видео      |
| Выход  | Отклик модели машинного обучения     |

> Наша модель машинного обучения обрабатывает кадр и выносит вердикт - отклик.

| Этап   | **4. Постобработка кадров**                  |
| ------ | -------------------------------------------- |
| Акторы | Jetson Nano: Модуль постобработки кадров     |
| Вход   | Отклик модели машинного обучения             |
| Выход  | Количество людей на кадрах и их расположение |

> Здесь мы принимаем отклик от нейросети и интерпретируем его:
> понимаем, сколько людей находится в комнате и где они располагаются.
> Данные о расположении людей могут быть использованы для отладки.

| Этап   | **5. Отдача обработанных данных на Бэкенд**                    |
| ------ | -------------------------------------------------------------- |
| Акторы | Jetson Nano: Модуль API, Бэкенд Модуль приема видео и откликов |
| Вход   | Оригинальный видеоряд и данные о людях в кадре                 |
| Выход  | Стрим данных видео с доп. информацией о людях в кадре          |

> Сопоставляем оригинальный ряд с выходом нейросети и формируем
> поток видео как с аннотациями вроде субтитров, который далее передаем по
> сети подключенным к нам подписчикам (Бэкенду) по установленному соединению.

| Этап   | **6. Принятие видеоряда и метаинформации на бэкенде**          |
| ------ | -------------------------------------------------------------- |
| Акторы | Jetson Nano: Модуль API, Бэкенд Модуль приема видео и откликов |
| Вход   | Стрим данных с Jetson Nano                                     |
| Выход  | Данные, преобразованные в программные сущности                 |

> Модуль приема видео и откликов принимает данные с Jetson Nano и
> конвертирует их в програмнные сущности, а также обрабатывает ошибки
> ввода-вывода.

| Этап   | **7. Сохранение результатов**                              |
| ------ | ---------------------------------------------------------- |
| Акторы | Бэкенд Модуль бизнес логики, Бэкенд Модуль хранения данных |
| Вход   | Видео-данные                                               |
| Выход  | -                                                          |

> Асинхронно сохраняем полученную информацию в базу данных.

| Этап   | **8. Трансляция видеоряда клиенту** |
| ------ | ----------------------------------- |
| Акторы | Бэкенд Модуль API, Клиент           |
| Вход   | Обработанные видео-данные           |
| Выход  | Поток видо-данных по сети           |

> Получение, подготовка к транслированию и транслирование 
> видеоряда по сети подключенному клинтскому приложению.

![Sequence Diagram](./res/sequence-diagram-draft.svg)

На Клиенте можно будет смотреть статистику по
количеству человек в помещении в конкретный момент
времени (быть может в виде таблицы), а также
просматривать видеопоток.

## Используемые технологии

| Компонента  | Прототип          | Продукт                    |
| ----------- | ----------------- | -------------------------- |
| Jetson Nano | Python 3, OpenCV  | C++, OpenCV                |
| Бэкенд      | Python 3, H2      | Java, Spring Boot, OpenAPI |
| Фронтэнд    | JavaScript, React | TypeScript, React          |

> Для предобработки видео на плате используем
> [фильтры](https://docs.opencv.org/3.4/d4/d86/group__imgproc__filter.html)
> из OpenCV. Для распознавания людей на кадрах применим нейронную сеть
> [Yunet](https://github.com/opencv/opencv_zoo/blob/master/models/face_detection_yunet/README.md)
> из библиотеки OpenCV. Передавать видео будем c помощью технологии
> [WebSocket](https://spring.io/guides/gs/messaging-stomp-websocket/),
> а отдавать статистику через REST API (либо реализуем все на gRPC).
> Документируем код средствами Doxygen и OpenAPI Swagger Codegen.
> Используем линтеры: checkstyle, clang-tidy, pylint.

## Требования к надежности

### Время работы

- Система должна функционировать 80% времени;

- Система должна работать с 8:00 до 20:00 в будние дни и
  с 11:30 до 18:30 по выходным;

- Допустимы перебои на 20-30 минут.

### Производительность

- Актуальность видео стрима - минута

- Время ответа до 5 секунд

- Количество одновременно работающих пользователей: 5

### Точность

- Минимум 80% записей о количестве людей в комнате точны

## Условия эксплуатации

- Камера и Jetson Nano находятся в помещении защищенном от влаги и пыли

- Камера не должна быть подвержена физическому воздействию (не бить)

- Камера и Jetson Nano желательно должны быть подключены к сети
  безперебойного питания

- Jetson Nano подключено к локальной сети

- Если что-то вышло из строя писать нам в ЛС

## Требования к составу и параметрам технических средств

Характеристики частей:

| Средство          | Характеристики                  |
| ----------------- | ------------------------------- |
| Камера            | 30 FPS, 1280 x 720              |
| Плата Jetson Nano | \*вставить параметры\*          |
| База данных       | PostgreSQL, 20 GB, master-slave |
| Бэкенд сервер     | 4 RAM, 200 GB WEB, 5 GB SSD     |

## Требования к информационной и программной совместимости

| Компонент   | Требования                                                         |
| ----------- | ------------------------------------------------------------------ |
| Jetson Nano | Ubuntu 22.04, Python 3, C++17, clang++, camera driver, WLAN        |
| Бэкенд      | Ubuntu 22.04, Python 3, JDK-18, JRE-18, Kotlin, Gradle, PostgreSQL |
| Фронтенд    | Ubuntu 22.04, NPM, React, TypeScript                               |

## Требования к транспортированию и хранению

### Безопасность

- Федеральный закон от 27.07.2006 No 149-ФЗ "Об информации, информационных
  технологиях и о защите информации"

# Требования к документации

- Описание алгоритмов основных и ссылки на источники

- Высокоуровневое описание процессов в системе

- Тикеты и ПРы в гитлабе

- Инструкции по сборке, установке и эксплуатации

# Технико-экономические показатели

| Оборудование  | Характеристики                      | Стоимость в рублях |
| ------------- | ----------------------------------- | ------------------ |
| Камера        | Камера                              | 8000 на единицу    |
| JetsonNano    | Плата                               | 25000 на единицу   |
| PostgreSQL    | 20 GB, master-slave                 | 6300 в месяц       |
| Compute Cloud | public, 4 RAM, 200 GB WEB, 5 GB SSD | 1300 в месяц       |

Compute Cloud:
https://cloud.yandex.com/en/prices?state=14203af79013#calculator

В разделе должны быть указаны: ориентировочная стоимость
единичного и серийного выпуска продукта, экономические
преимущества разработки по сравнению с лучшими отечественными
и зарубежными образцами или аналогами.

# Cтадии и этапы разработки

| Недели  | Деятельность                                              |
| ------- | --------------------------------------------------------- |
| 2 - 4   | Установка технического задания и согласование проекта     |
| 5 - 8   | Проектирование архитектуры, выбор инструментов разработки |
| 9 - 12  | Прототипирование, создание MVP                            |
| 13 - 18 | Реализация                                                |

# Порядок контроля и приемки

??? В разделе должны быть указаны виды испытаний и общие требования к
приемке работы.

# Ссылки на источники

1. ГОСТ 19.201-78 Техническое задание.
   Требования к содержанию и оформлению.
